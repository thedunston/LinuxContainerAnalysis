#!/bin/bash

# Trace Malware Execution Script
# Automatically traces a binary with strace and logs all activity

if [ $# -eq 0 ]; then
    echo "Usage: $0 <malware_binary> [arguments...]"
    echo ""
    echo "This script will:"
    echo "  - Run the malware under strace"
    echo "  - Log all system calls"
    echo "  - Capture file operations, network activity, and process creation"
    echo ""
    exit 1
fi

MALWARE_PATH="$1"
shift
MALWARE_ARGS="$@"

if [ ! -f "$MALWARE_PATH" ]; then
    echo "Error: File not found: $MALWARE_PATH"
    exit 1
fi

MALWARE_NAME=$(basename "$MALWARE_PATH")
LOG_DIR="/var/log/malware-trace"
mkdir -p "$LOG_DIR"

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
STRACE_LOG="$LOG_DIR/${MALWARE_NAME}_${TIMESTAMP}_strace.log"
LTRACE_LOG="$LOG_DIR/${MALWARE_NAME}_${TIMESTAMP}_ltrace.log"
OUTPUT_LOG="$LOG_DIR/${MALWARE_NAME}_${TIMESTAMP}_output.log"

echo "========================================="
echo "  Tracing Malware Execution"
echo "========================================="
echo ""
echo "Malware: $MALWARE_PATH"
echo "Arguments: $MALWARE_ARGS"
echo ""
echo "Logs will be saved to:"
echo "  - System calls: $STRACE_LOG"
echo "  - Library calls: $LTRACE_LOG"
echo "  - Program output: $OUTPUT_LOG"
echo ""
echo "Starting trace..."
echo ""

# Run with strace and ltrace simultaneously
strace -f -t -T -s 1024 \
    -e trace=all \
    -o "$STRACE_LOG" \
    ltrace -f -t -T -s 1024 \
    -o "$LTRACE_LOG" \
    "$MALWARE_PATH" $MALWARE_ARGS \
    > "$OUTPUT_LOG" 2>&1

EXIT_CODE=$?

echo ""
echo "========================================="
echo "  Trace Complete"
echo "========================================="
echo ""
echo "Exit code: $EXIT_CODE"
echo ""
echo "Analysis Summary:"
echo ""

# Analyze strace log
if [ -f "$STRACE_LOG" ]; then
    echo "=== System Call Summary ==="
    echo "Total syscalls: $(wc -l < "$STRACE_LOG")"
    echo ""
    echo "Top 10 syscalls:"
    grep -oP '^\d+:\d+:\d+ [a-z_]+' "$STRACE_LOG" | awk '{print $2}' | sort | uniq -c | sort -rn | head -10
    echo ""
    
    echo "=== File Operations ==="
    echo "Files opened:"
    grep -E 'open(at)?\(' "$STRACE_LOG" | grep -oP '"[^"]*"' | sort -u | head -20
    echo ""
    
    echo "=== Network Activity ==="
    echo "Network syscalls:"
    grep -E 'socket|connect|bind|listen|accept|send|recv' "$STRACE_LOG" | head -20
    echo ""
    
    echo "=== Process/Thread Creation ==="
    echo "fork/clone/execve calls:"
    grep -E 'fork|clone|execve' "$STRACE_LOG" | head -20
    echo ""
fi

# Analyze ltrace log
if [ -f "$LTRACE_LOG" ]; then
    echo "=== Library Call Summary ==="
    echo "Total library calls: $(wc -l < "$LTRACE_LOG")"
    echo ""
    echo "Top 10 library calls:"
    grep -oP '^\d+:\d+:\d+ [a-zA-Z_]+' "$LTRACE_LOG" | awk '{print $2}' | sort | uniq -c | sort -rn | head -10
    echo ""
fi

echo "Full logs available at:"
echo "  $STRACE_LOG"
echo "  $LTRACE_LOG"
echo "  $OUTPUT_LOG"
echo ""
